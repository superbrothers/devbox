# DO NOT EDIT THIS FILE DIRECTLY
# This file is generated by `make Dockerfile`

FROM ubuntu:18.04 AS stage-0

# Install build-essential etc
RUN set -x -e && \
    apt-get update && \
    apt-get install -y \
        build-essential \
        bash \
        apt-utils \
        locales \
        curl \
        file \
        git \
        wget \
        tree \
        zip \
        man \
        sudo && \
    locale-gen en_US.UTF-8 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

SHELL ["/bin/bash", "-c"]

COPY etc/apt/apt.conf.d/01norecommend /etc/apt/apt.conf.d/01norecommend

# Create a user
ENV USER=dev
RUN set -x -e && \
    groupadd -g 999 docker && \
    useradd -G docker -m -s /bin/bash "$USER" && \
    echo "$USER ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

USER "$USER"
ENV HOME="/home/$USER"

# Install Linuxbrew
# https://github.com/Homebrew/brew/blob/master/docs/Linuxbrew.md
RUN set -x -e && \
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/Linuxbrew/install/master/install.sh)" && \
    eval $(/home/linuxbrew/.linuxbrew/bin/brew shellenv) && \
    brew --version && \
    brew update && \
    brew cleanup

ENV PATH="/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin:$PATH"

ENV HOMEBREW_NO_AUTO_UPDATE=1

# Install development packages
<%
brew_packages = []
File.foreach("packages.txt") do |line|
  splits = line.split(" ")
  brew_packages.push({name: splits[0], version: splits[1]})
end
%>
<% brew_packages.each do |package| %>
FROM stage-0 AS brew-<%= package[:name] %>
ENV VERSION <%= package[:version] %>
RUN set -x && brew install <%= package[:name] %>

<% end %>

# Install go tools
FROM brew-go AS go-tools
ENV GOPATH="/go"
RUN set -x -e && \
    sudo mkdir "$GOPATH" && \
    sudo chown "$USER:$USER" "$GOPATH" && \
    export GOCACHE=/tmp && \
    go get github.com/nsf/gocode && \
    go get github.com/motemen/ghq

# Install asdf-vm
# https://github.com/asdf-vm/asdf
FROM stage-0 AS asdf
ENV ASDF_DATA_DIR=/asdf
RUN set -x -e && \
    sudo mkdir "$ASDF_DATA_DIR" && \
    sudo chown "$USER:$USER" "$ASDF_DATA_DIR" && \
    git clone https://github.com/asdf-vm/asdf.git "$ASDF_DATA_DIR" && \
    . $ASDF_DATA_DIR/asdf.sh && \
    # Create symlinks
    ln -s "${HOME}/.asdf/installs" "${ASDF_DATA_DIR}/installs" && \
    ln -s "${HOME}/.asdf/shims" "${ASDF_DATA_DIR}/shims" && \
    # Install plugins
    asdf plugin-add golang https://github.com/kennyp/asdf-golang && \
    asdf plugin-add node https://github.com/asdf-vm/asdf-nodejs && \
    asdf plugin-add kubectl https://github.com/Banno/asdf-kubectl

FROM stage-0
<% brew_packages.each do |package| %>
COPY --from=brew-<%= package[:name] %> /home/linuxbrew/.linuxbrew/ /home/linuxbrew/.linuxbrew/
<% end %>
COPY --from=go-tools /go/ /go/
COPY --from=asdf /asdf/ /asdf/
ENV PATH="/go/bin:$PATH"

# Set default environment variables
ENV EDITOR=vim
ENV GOPATH="$HOME"
ENV GHQ_ROOT="$HOME/src"
ENV LESSCHARSET=utf-8
ENV ASDF_DATA_DIR=/asdf

COPY etc/profile.d/asdf.sh /etc/profile.d/asdf.sh
